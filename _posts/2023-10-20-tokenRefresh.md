---
title: 前端实现无感刷新token
categories: [文章]
comments: true
---

## 现象

现在前端改东西发布后，如果用户没刷新的情况下，切换页面，可能会报错。

## 原因

文件做了路由按需加载，也就是说只有切页面的时候，才去加载对应代码。但是这样做会引发一个问题，假如用户一直在使用系统，这时候我们改了某个页面的代码，用户在没打开过那个页面的情况下，（如果用户打开过，因为前端会把加载过的代码缓存在内存中，不去从服务器加载 js，这种情况不会报错。）我们发布后，因为这当前文件的 hash 值已经变了，老的那个 js 文件已经不存在了，所以这时候用户再切到那个页面就会报错。

## 方案

#### 一、多版本

按照以上描述，因为新发布的代码会把老的文件覆盖，那当我们每次打包时，把老的代码文件保存下来就好。

1.1 实现思路

在 CI 中，拉取上一个版本的镜像，然后复制出上一版本的代码，然后和当前打包出来的文件夹合并，然后就打出一个新的镜像。

1.2 弊端

用户页面一直不刷新，改的代码会一直不生效，需通知用户手动刷新。同时后端有更改时，也需要支持多版本，不然版本对不上可能会报错。

#### 二、后端给前端推送消息，刷新页面

2.1 实现思路

后端写一个接口，使用 websocket 通知，前端接收到对应消息后，调用浏览器自动刷新。

2.2 弊端

自动刷新，如果用户正在填写东西或操作，肯定不可以，如果给用户选项稍后刷新，用户稍后可能会忘记，还是会出现报错。

#### 三、监听文件不存在，刷新页面

3.1 实现思路
简单存包，全局监听 js 资源加载 404，如果 404，则刷新页面

```
window.addEventListener('error', function(event) {
  const target = event.target;
  if (target.tagName === 'SCRIPT' && target.src) {
    window.location.reload();
  }
}, true)
```

#### 四、轮询检查 index.html，查询 js 有没有变动

4.1 实现思路

前端写一个定时器，定时请求 index.html 文件内容，判断当前内容和上次是否一样，若不一样，刷新页面。

#### 五、 用户无感升级

5.1 实现思路

既然文件加载失败了，我们只要发现文件加载失败了，找到正确的资源文件名重新加载就行了。当文件加载失败时，怎么找到对应的资源文件名呢，这里用到了 manifest.json 文件，打包资源的文件映射，有了它我们知道了文件名就能找到打包后的文件路径。

#### 五、 用户无感升级

5.1 背景

网站发版过程中，用户正在浏览 web 页面，可能会导致页面无法加载对应的资源，导致报错或无反应的情况，严重影响用户体验

5.2 分析

- 问题：网络控制台显示加载资源 404

- 条件：1.站点时 spa 页面，并开启懒加载；2.资源地址启用内容 hash。（加载更快启用了强缓存，为了应对资源变更能及时更新内容，会对资源地址的文件名加上内容 hash）；3.覆盖式部署，新版本发布后旧的版本会被删除。

- 原因：浏览器打开页面后，会记录路由和资源路径的映射，服务器发版后，没有及时通知浏览器更新路由映射表。导致用户在发布前端打开的页面，在版本更新后，进入下一个路由加载上一个版本的资源失败，导致需要用户刷新才能正常使用。

  5.3 方案

  5.3.1 失败重试
